### Coppersmith 攻击（p、q 部分位数泄露）

话不多说，直接上题（2021 鹤城杯）

```python
from Crypto.Util.number import getPrime, bytes_to_long
from secret import flag

p = getPrime(1024)
q = getPrime(1024)
n = p * q
e = 65537
hint1 = p >> 724
hint2 = q % (2 ** 265)
ct = pow(bytes_to_long(flag), e, n)
print(hint1)
print(hint2)
print(n)
print(ct)

"""
hint1 = 1514296530850131082973956029074258536069144071110652176122006763622293335057110441067910479
hint2 = 40812438243894343296354573724131194431453023461572200856406939246297219541329623
n = 21815431662065695412834116602474344081782093119269423403335882867255834302242945742413692949886248581138784199165404321893594820375775454774521554409598568793217997859258282700084148322905405227238617443766062207618899209593375881728671746850745598576485323702483634599597393910908142659231071532803602701147251570567032402848145462183405098097523810358199597631612616833723150146418889589492395974359466777040500971885443881359700735149623177757865032984744576285054725506299888069904106805731600019058631951255795316571242969336763938805465676269140733371287244624066632153110685509892188900004952700111937292221969
ct = 19073695285772829730103928222962723784199491145730661021332365516942301513989932980896145664842527253998170902799883262567366661277268801440634319694884564820420852947935710798269700777126717746701065483129644585829522353341718916661536894041337878440111845645200627940640539279744348235772441988748977191513786620459922039153862250137904894008551515928486867493608757307981955335488977402307933930592035163126858060189156114410872337004784951228340994743202032248681976932591575016798640429231399974090325134545852080425047146251781339862753527319093938929691759486362536986249207187765947926921267520150073408188188
"""
```

$$
\begin{aligned}
&Let\ \ q0\ =\ q\ mod\ 2^{265}\\
&\therefore\ q\ =\ q0\ +\ 2^{265}k\\
&\therefore\ n = \ q0\ p\ +\ 2^{265}\ k\ p\\
&\therefore\ n\ q0^{-1}\ =\ p\ +\ 2^{265}\ k\ p\ q0^{-1}\\\\
&Let\ \ k\ =\ k\ p\ q0^{-1}\\
&\therefore\ n\ q0^{-1}\ =\ p\ +\ 2^{265}k\\
&\because\ c\ =\ m ^ e\ mod\ n\\
&\therefore\ m ^ e\ =kn\ +\ c\\
&\therefore\ p0\ =\ n\ q0^{-1}\ mod\ 2^{265}\\\\
&(Here\ p0\ represents\ the\ lower\ 265\ bits\ of\ p)
\end{aligned}
$$

```
那么 p 的高 300 位和低 265 位之和为：

(hint1 << 724) + p0

其中间的 459 位通过 copperSmith 求解

正常情况下是构造 f = pbar + x * 265，但是因为位数不够所以需要抬高 64 爆破（要求已知位数 >= 570bit）

每次加 2 ^ 265

sage 求解的固定方式：

PR.<x> = PolynomialRing(Zmod(n))

f = ...

f = f.monic()

f.small_roots(X = 2 ^ (sizep-knownbits) - 1, beta = 0.4)
```

```python
hint1 = 1514296530850131082973956029074258536069144071110652176122006763622293335057110441067910479

hint2 = 40812438243894343296354573724131194431453023461572200856406939246297219541329623

n = 21815431662065695412834116602474344081782093119269423403335882867255834302242945742413692949886248581138784199165404321893594820375775454774521554409598568793217997859258282700084148322905405227238617443766062207618899209593375881728671746850745598576485323702483634599597393910908142659231071532803602701147251570567032402848145462183405098097523810358199597631612616833723150146418889589492395974359466777040500971885443881359700735149623177757865032984744576285054725506299888069904106805731600019058631951255795316571242969336763938805465676269140733371287244624066632153110685509892188900004952700111937292221969

p0 = n * (hint2 ^ -1) % (2 ^ 265)

pbar = (hint1 << 724) + p0

PR.<x> = PolynomialRing(Zmod(n))

# 循环爆破
for i in range(64):
    f = pbar + x * (2 ^ 265) * 64 + x * (2 ^ 265)
    
    # f.monic()：将多项式转换为一个单项式化多项式，其最高次项的系数为 1
    f = f.monic()
    
    pp = f.small_roots(X = 2 ^ 453, beta = 0.4)
    
    if pp:
        break
        
    pbar += 2 ^ 265

p = int(pbar + pp[0] * 32 * (2 ^ 265))

print("p=", p)
```

去[在线网站](https://sagecell.sagemath.org/)解出 p

![](https://pic1.imgdb.cn/item/6787b2f2d0e0a243d4f492ae.png)
